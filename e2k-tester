#!/usr/bin/env python3
"""Repository launcher for `python e2k-tester`."""

from __future__ import annotations

import os
import subprocess
import sys
from pathlib import Path

_VENV_REENTRY_ENV = "E2K_TESTER_VENV_REENTRY"


def _repo_root() -> Path:
    return Path(__file__).resolve().parent


def _ensure_src_on_path() -> None:
    src_path = _repo_root() / "src"
    if str(src_path) not in sys.path:
        sys.path.insert(0, str(src_path))


def _local_venv_python(repo_root: Path) -> Path | None:
    candidates = (
        repo_root / ".venv" / "bin" / "python",
        repo_root / ".venv" / "Scripts" / "python.exe",
    )
    for candidate in candidates:
        if candidate.exists():
            return candidate
    return None


def _run_cli_in_process(argv: list[str]) -> int:
    _ensure_src_on_path()
    from simple_e2e_tester.cli import main  # pylint: disable=import-outside-toplevel

    return main(argv)


def _run_bootstrap(repo_root: Path) -> int:
    _ensure_src_on_path()
    from simple_e2e_tester.bootstrap import (  # pylint: disable=import-outside-toplevel
        BootstrapError,
        bootstrap_project_environment,
    )

    try:
        bootstrap_project_environment(repo_root=repo_root)
    except BootstrapError as exc:
        print(str(exc), file=sys.stderr)
        return 1
    print(f"local virtual environment ready: {repo_root / '.venv'}")
    return 0


def main(argv: list[str] | None = None) -> int:
    repo_root = _repo_root()
    args = list(sys.argv[1:] if argv is None else argv)
    if args and args[0] == "bootstrap":
        return _run_bootstrap(repo_root)
    try:
        return _run_cli_in_process(args)
    except ModuleNotFoundError as exc:
        if os.environ.get(_VENV_REENTRY_ENV) == "1":
            missing_module = exc.name or "required dependency"
            print(
                f"Unable to start CLI because `{missing_module}` is not available. "
                "Run `uv sync` and retry.",
                file=sys.stderr,
            )
            return 1
        venv_python = _local_venv_python(repo_root)
        if venv_python is None:
            print(
                "Missing local virtual environment. Run `uv sync` at repository root first.",
                file=sys.stderr,
            )
            return 1
        env = dict(os.environ)
        env[_VENV_REENTRY_ENV] = "1"
        completed = subprocess.run(
            [str(venv_python), str(repo_root / "e2k-tester"), *args],
            check=False,
            env=env,
        )
        return completed.returncode


if __name__ == "__main__":
    raise SystemExit(main())
